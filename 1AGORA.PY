import streamlit as st
import pandas as pd
from groq import Groq
from datetime import datetime

# --- 1. CONFIGURATION (Titre de l'onglet = 1AGORA) ---
st.set_page_config(page_title="1AGORA", page_icon="üè¢")

# Masquer le menu technique pour faire "Pro"
hide_menu = """<style>#MainMenu {visibility: hidden;} footer {visibility: hidden;} header {visibility: hidden;}</style>"""
st.markdown(hide_menu, unsafe_allow_html=True)

st.title("üè¢ Agence PRO'AGORA - Classe de 1√®re")

# --- 2. CONNEXION GROQ ---
try:
    api_key = st.secrets["GROQ_API_KEY"]
    client = Groq(api_key=api_key)
except:
    st.error("‚ö†Ô∏è Cl√© API manquante. V√©rifiez les 'Secrets' de Streamlit.")
    st.stop()

# ==============================================================================
# LA BIBLIOTH√àQUE DES SC√âNARIOS (Bas√©e sur vos livres Foucher)
# ==============================================================================

# --- R√âVISIONS DE SECONDE (Livre Gestion Admin des Activit√©s) ---
DB_SECONDE = {
    "P√¥le 1 : Gestion Relations Externes": {
        "Dossier 1 : L'accueil physique et t√©l√©phonique": """
        CONTEXTE : Tu es √† l'accueil de l'entreprise 'Azur Buro'.
        DONN√âES : Tu re√ßois un appel de M. Dupuis (Client) qui est m√©content d'un retard.
        MISSION : 1. R√©diger la fiche de prise de message. 2. Proposer une phrase de r√©ponse diplomate.
        """,
        "Dossier 2 : La gestion du courrier": """
        CONTEXTE : Le courrier du matin est arriv√© (5 lettres : 1 pub, 1 ch√®que client, 1 facture fournisseur, 1 CV, 1 lettre mairie).
        MISSION : 1. Pr√©senter le tableau de tri (Service destinataire / Importance). 2. Enregistrer le ch√®que √† l'arriv√©e.
        """,
        "Dossier 3 : Le classement et l'archivage": """
        CONTEXTE : Le serveur r√©seau est en d√©sordre. Le chef ne retrouve pas les devis de 2023.
        MISSION : Proposer une arborescence de classement num√©rique (Dossiers/Sous-dossiers) pour le service Commercial.
        """
    }
}

# --- PROGRAMME DE PREMI√àRE (Livre Assurer le Suivi Administratif) ---
DB_PREMIERE = {
    "Th√®me 1 : Suivi des Ventes (Clients)": {
        "Chapitre 1 : Devis et Commandes": """
        CONTEXTE : Client 'SARL BATI-SUD'. Demande prix pour 1000 briques r√©f B45 et 50 sacs ciment.
        DONN√âES : Brique=0.80‚Ç¨ HT, Ciment=12‚Ç¨ HT. Remise 5% si > 1000‚Ç¨. TVA 20%.
        MISSION : 1. √âtablir le Devis. 2. V√©rifier le Bon de Commande re√ßu ensuite (n¬∞ BC-102).
        """,
        "Chapitre 2 : Livraison et Facturation": """
        CONTEXTE : Suite √† la commande BATI-SUD. La livraison a eu lieu le 12/10.
        DONN√âES : Bon de livraison BL-98. Aucun incident.
        MISSION : √âtablir la facture d√©finitive F-2024-089. V√©rifier les montants.
        """,
        "Chapitre 3 : Suivi des R√®glements": """
        CONTEXTE : La facture F-2024-089 (BATI-SUD) date d'il y a 40 jours. D√©lai accord√© : 30 jours.
        MISSION : 1. Constater le retard. 2. R√©diger un mail de relance niveau 1 (amiable).
        """
    },
    "Th√®me 2 : Suivi des Achats (Fournisseurs)": {
        "Chapitre 4 : Recherche Fournisseurs": """
        CONTEXTE : Besoin d'une imprimante laser pro pour le secr√©tariat. Budget max 400‚Ç¨.
        MISSION : Comparer 3 offres (Canon, HP, Brother) sur les crit√®res : Prix, Vitesse, Co√ªt toner, Garantie.
        """,
        "Chapitre 5 : Commande et R√©ception": """
        CONTEXTE : Imprimante Brother choisie. Elle arrive mais le carton est ab√Æm√©.
        MISSION : 1. R√©diger le Bon de Commande. 2. R√©diger les r√©serves √† porter sur le bon de transport.
        """
    },
    "Th√®me 3 : Tr√©sorerie et Stocks": {
        "Chapitre 6 : Rapprochement Bancaire": """
        CONTEXTE : Relev√© bancaire BNP re√ßu. Le solde ne correspond pas √† notre compte 512.
        MISSION : Identifier les op√©rations manquantes (ch√®ques non encaiss√©s, frais bancaires).
        """,
        "Chapitre 7 : Suivi des Stocks": """
        CONTEXTE : Inventaire des ramettes de papier. Stock th√©orique : 50. Stock r√©el compt√© : 42.
        MISSION : 1. Calculer l'√©cart. 2. Mettre √† jour la fiche de stock. 3. Proposer une explication.
        """
    }
}

# ==============================================================================

# --- 3. LE CERVEAU (PROMPT SYST√àME) ---
SYSTEM_PROMPT = """
Tu es le Superviseur de l'Agence PRO'AGORA.
Tu as acc√®s au DOSSIER CORRIG√â que l'√©l√®ve a choisi.

TON R√îLE :
1. **Donner les donn√©es :** D√®s le d√©but, fournis √† l'√©l√®ve le CONTEXTE exact et les DONN√âES (Prix, Noms, Dates) du dossier choisi ci-dessus. Il ne doit pas les inventer.
2. **Guider :** Si le dossier comporte plusieurs √©tapes, guide-le une √©tape apr√®s l'autre.
3. **Corriger :** V√©rifie sa rigueur administrative (Mentions obligatoires, calculs, orthographe).
4. **Bilan :** √Ä la fin, g√©n√®re le rapport pour le professeur.

RAPPEL : Tu ne fais jamais le travail √† sa place. Tu donnes les "billes" (le sujet), il fait le jeu.
"""

# --- 4. GESTION LOGS ---
if "conversation_log" not in st.session_state:
    st.session_state.conversation_log = []

def save_log(student_id, role, content):
    timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    st.session_state.conversation_log.append({
        "Heure": timestamp, "Eleve": student_id, "Role": role, "Message": content
    })

# --- 5. INTERFACE DE NAVIGATION (SIDEBAR) ---
with st.sidebar:
    st.header("üóÇÔ∏è Navigation 1AGORA")
    
    # Identifiant
    student_id = st.text_input("Votre Pr√©nom :")
    st.markdown("---")
    
    # S√©lecteur de Niveau
    niveau = st.radio("Choix du Module :", ["1√®re (Suivi Administratif)", "2nde (R√©visions GATL)"])
    
    # Chargement de la base de donn√©es
    if niveau == "1√®re (Suivi Administratif)":
        base_active = DB_PREMIERE
    else:
        base_active = DB_SECONDE
        
    # S√©lecteurs Th√®me/Dossier
    theme_choisi = st.selectbox("Th√®me :", list(base_active.keys()))
    dossier_choisi = st.selectbox("Activit√© / Dossier :", list(base_active[theme_choisi].keys()))
    
    # Bouton d'Action
    st.markdown("---")
    if st.button("üöÄ LANCER LE DOSSIER", type="primary"):
        contexte_mission = base_active[theme_choisi][dossier_choisi]
        start_msg = f"üëã Bonjour Op√©rateur. Tu as choisi : **{dossier_choisi}**.\n\nVoici le contexte du dossier :\n{contexte_mission}\n\nQuelle est ta premi√®re action ?"
        st.session_state.messages = [{"role": "assistant", "content": start_msg}]
        st.rerun()

    # Sauvegarde / Restauration
    st.markdown("---")
    st.subheader("üíæ Sauvegarde")
    if st.session_state.conversation_log:
        df = pd.DataFrame(st.session_state.conversation_log)
        csv = df.to_csv(index=False, sep=';').encode('utf-8-sig')
        st.download_button("üì• T√©l√©charger mon travail", csv, "suivi_1agora.csv", "text/csv")
        
    uploaded_file = st.file_uploader("Reprendre un travail (CSV)", type=['csv'])
    if uploaded_file and st.button("üîÑ Restaurer"):
        try:
            df_hist = pd.read_csv(uploaded_file, sep=';')
            st.session_state.messages = []
            st.session_state.conversation_log = []
            for _, row in df_hist.iterrows():
                role_chat = "user" if row['Role'] == "Eleve" else "assistant"
                st.session_state.messages.append({"role": role_chat, "content": row['Message']})
                save_log(row.get('Eleve', student_id), row['Role'], row['Message'])
            st.success("Restaur√© !")
            st.rerun()
        except: st.error("Erreur fichier")

# --- 6. CHAT ---
if "messages" not in st.session_state:
    st.info("‚¨ÖÔ∏è Bienvenue sur **1AGORA**. Veuillez choisir un dossier dans le menu de gauche et cliquer sur 'LANCER LE DOSSIER'.")
    st.stop() 

# Affichage
for msg in st.session_state.messages:
    st.chat_message(msg["role"]).write(msg["content"])

# Interaction
if prompt := st.chat_input("Votre r√©ponse..."):
    if not student_id:
        st.warning("‚ö†Ô∏è Mettez votre pr√©nom √† gauche !")
    else:
        st.chat_message("user").write(prompt)
        st.session_state.messages.append({"role": "user", "content": prompt})
        save_log(student_id, "Eleve", prompt)

        try:
            msgs = [{"role": "system", "content": SYSTEM_PROMPT}]
            msgs.extend([{"role": m["role"], "content": m["content"]} for m in st.session_state.messages])

            chat = client.chat.completions.create(
                messages=msgs,
                model="llama-3.3-70b-versatile",
                temperature=0.7
            )
            bot_reply = chat.choices[0].message.content
            
            st.chat_message("assistant").write(bot_reply)
            st.session_state.messages.append({"role": "assistant", "content": bot_reply})
            save_log(student_id, "Superviseur", bot_reply)
            st.rerun()
        except Exception as e:
            st.error(f"Erreur : {e}")
